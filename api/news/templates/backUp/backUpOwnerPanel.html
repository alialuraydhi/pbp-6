
{% extends 'base.html' %}
{% load static %}
{% block meta %}
<title>Berita</title>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
<meta name="csrf-token" content="{{ csrf_token }}">
{% endblock meta %}
{% block content %}
<div class="bg-[#f3ebdb]">
    <div class="container mx-auto px-4 py-8 mt-16 ">
        <h1 class="text-4xl font-bold text-center mb-8 text-[#c1a386]">
            Daftar Berita
        </h1>

        <div class="flex justify-end mb-6">
            <button
                class="bg-[#c1a386] hover:bg-[#a48b72] text-[#fffbf2] font-bold py-2 px-4 rounded-lg transition duration-300 shadow-md transition duration-300"
                onclick="showAddModal()"
            >
                Tambah Berita
            </button>
        </div>

        <div id="berita_entry_list" >
        </div>
    </div>
</div>


    <!-- ADD MODAL -->
    <div id="addModal" tabindex="-1" aria-hidden="true" class="hidden fixed inset-0 z-50 w-full flex items-center justify-center bg-gray-800 bg-opacity-50 overflow-x-hidden overflow-y-auto transition-opacity duration-300 ease-out">
        <div id="addModalContent" style="background-color: rgba(125, 110, 95, 0.9);" class="relative rounded-lg shadow-lg w-5/6 sm:w-3/4 md:w-1/2 lg:w-1/3 mx-4 sm:mx-0 transform scale-95 opacity-0 transition-transform transition-opacity duration-300 ease-out">
            <!-- Modal header -->
            <div class="flex items-center justify-between p-4 border-b border-gray-200 rounded-t">
                <h3 class="text-xl font-semibold text-[#fffbf2]">Add Berita</h3>
                <button type="button" class="text-[#fffbf2] bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center" id="closeAddModalBtn">
                    <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                    <span class="sr-only">Close modal</span>
                </button>
            </div>
            <!-- Modal body -->
            <div class="px-6 py-4 space-y-6 form-style">
                <form id="addBeritaForm">
                    {% csrf_token %}
                    <div class="mb-4">
                        <label for="judul" class="block text-sm font-medium text-[#fffbf2]">Judul</label>
                        <input type="text" id="judul" name="judul" class="mt-1 block w-full border border-fffbf2 bg-[#aba197] text-[#fffbf2] rounded-md p-2 hover:border-[#aba197] focus:border-[#aba197] placeholder-[#fffbf2]" placeholder="Enter berita judul" required>
                    </div>
                    <div class="mb-4">
                        <label for="gambar" class="block text-sm font-medium text-[#fffbf2]">Gambar</label>
                        <div class="flex justify-center items-center mt-1">
                            <div id="wrapImageAdd" class="w-1/2 mx-3 hidden"></div>
                            <input type="file" id="gambar" name="gambar" class="block w-full border border-fffbf2 bg-[#aba197] text-[#fffbf2] rounded-md p-2 hover:border-[#aba197] focus:border-[#aba197] placeholder-[#fffbf2]" accept="image/*" required onchange="previewImage(event, 'wrapImageAdd')">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="konten" class="block text-sm font-medium text-[#fffbf2]">Konten</label>
                        <textarea id="konten" name="konten" rows="5" class="mt-1 block w-full resize-none border border-fffbf2 bg-[#aba197] text-[#fffbf2] rounded-md p-2 hover:border-[#aba197] focus:border-[#aba197] placeholder-[#fffbf2]" placeholder="Enter berita konten" required></textarea>
                    </div>
                </form>
            </div>
            <!-- Modal footer -->
            <div class="flex flex-col space-y-2 md:flex-row md:space-y-0 md:space-x-2 p-6 border-t border-gray-200 rounded-b justify-center md:justify-end">
                <button type="button" class="bg-[#c5beb7] hover:bg-[#b9b1a9] text-white font-bold py-2 px-4 rounded-lg" id="cancelAddButton">Cancel</button>
                <button type="submit" id="submitBeritaEntry" form="addBeritaForm" class="bg-[#c1a386] hover:bg-[#a48b72] text-white font-bold py-2 px-4 rounded-lg">Save</button>
            </div>
        </div>
    </div>

    <!-- EDIT MODAL -->
    <div id="editModal" tabindex="-1" aria-hidden="true" class="hidden fixed inset-0 z-50 w-full flex items-center justify-center bg-gray-800 bg-opacity-50 overflow-x-hidden overflow-y-auto transition-opacity duration-300 ease-out">
        <div id="editModalContent" style="background-color: rgba(125, 110, 95, 0.9);" class="relative rounded-lg shadow-lg w-5/6 sm:w-3/4 md:w-1/2 lg:w-1/3 mx-4 sm:mx-0 transform scale-95 opacity-0 transition-transform transition-opacity duration-300 ease-out">
            <!-- Modal header -->
            <div class="flex items-center justify-between p-4 border-b border-gray-200 rounded-t">
                <h3 class="text-xl font-semibold text-[#fffbf2]">Edit Berita</h3>
                <button type="button" class="text-[#fffbf2] bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center" id="closeEditModalBtn">
                    <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                    <span class="sr-only">Close modal</span>
                </button>
            </div>
            <!-- Modal body -->
            <div class="px-6 py-4 space-y-6 form-style">
                <form id="editBeritaForm">
                    {% csrf_token %}
                    <div class="mb-4">
                        <label for="edit_judul" class="block text-sm font-medium text-[#fffbf2]">Judul</label>
                        <input type="text" id="edit_judul" name="judul" class="mt-1 block w-full border border-fffbf2 bg-[#aba197] text-[#fffbf2] rounded-md p-2" required>
                    </div>
                    <div class="mb-4">
                        <label for="edit_image" class="block text-sm font-medium text-[#fffbf2]">Ganti Gambar (opsional)</label>
                        <div class="flex justify-center items-center mt-1">
                            <div id="wrapImageEdit" class="w-1/2 mx-3">
                                <!-- Image preview element -->
                                <img id="edit_image_preview" src="" alt="Image Preview" class="w-full h-auto rounded-md">
                            </div>
                            <input type="file" id="edit_image" name="image" class="mt-1 block w-full border border-fffbf2 bg-[#aba197] text-[#fffbf2] rounded-md p-2" accept="image/*" onchange="previewImage(event, 'wrapImageEdit')">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="edit_konten" class="block text-sm font-medium text-[#fffbf2]">Konten</label>
                        <textarea id="edit_konten" name="konten" rows="5" class="mt-1 block w-full resize-none border border-fffbf2 bg-[#aba197] text-[#fffbf2] rounded-md p-2" required></textarea>
                    </div>
                </form>
            </div>
            <!-- Modal footer -->
            <div class="flex flex-col space-y-2 md:flex-row md:space-y-0 md:space-x-2 p-6 border-t border-gray-200 rounded-b justify-center md:justify-end">
                <button type="button" class="bg-[#c5beb7] hover:bg-[#b9b1a9] text-white font-bold py-2 px-4 rounded-lg" id="cancelEditButton">Cancel</button>
                <button type="submit" id="submitEditBeritaEntry" form="editBeritaForm" class="bg-[#c1a386] hover:bg-[#a48b72] text-white font-bold py-2 px-4 rounded-lg">Save</button>
            </div>
        </div>
    </div>
    
    <!-- DELETE MODAL -->
    <div id="deleteModal" tabindex="-1" aria-hidden="true" class="hidden fixed inset-0 z-50 w-full flex items-center justify-center bg-gray-800 bg-opacity-50 overflow-x-hidden overflow-y-auto transition-opacity duration-300 ease-out">
        <div id="deleteModalContent" style="background-color: rgba(125, 110, 95, 0.9);" class="relative rounded-lg shadow-lg w-5/6 sm:w-3/4 md:w-1/2 lg:w-1/3 mx-4 sm:mx-0 transform scale-95 opacity-0 transition-transform transition-opacity duration-300 ease-out">
            <!-- Modal header -->
            <div class="flex items-center justify-between p-4 border-b border-gray-200 rounded-t">
                <h3 class="text-xl font-semibold text-[#fffbf2]">Hapus Berita</h3>
                <button type="button" class="text-[#fffbf2] bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center" id="closeDeleteModalBtn">
                    <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                    <span class="sr-only">Close modal</span>
                </button>
            </div>
            <!-- Modal body -->
            <div class="px-6 py-4 space-y-6 form-style">
                <p class="text-[#fffbf2]">Apakah Anda yakin ingin menghapus berita ini?</p>
            </div>
            <!-- Modal footer -->
            <div class="flex flex-col space-y-2 md:flex-row md:space-y-0 md:space-x-2 p-6 border-t border-gray-200 rounded-b justify-center md:justify-end">
                <button type="button" class="bg-[#c5beb7] hover:bg-[#b9b1a9] text-white font-bold py-2 px-4 rounded-lg mr-2" id="cancelDeleteButton">Cancel</button>
                <button type="button" id="confirmDeleteButton" class="bg-[#c1a386] hover:bg-[#a48b72] text-white font-bold py-2 px-4 rounded-lg">Delete</button>
            </div>
        </div>
    </div>

</div>


<script>  
    async function getBerita(){
        return fetch("{% url 'news:show_berita_json' %}").then((res) => res.json())
    }

    async function refreshBeritaList() {
        document.getElementById("berita_entry_list").innerHTML = "";
        document.getElementById("berita_entry_list").className = "";
        const productEntries = await getBerita();
        
        let htmlString = "";
        let classNameString = "";
        if (productEntries.length === 0) {
            classNameString = "flex flex-col items-center justify-center min-h-[24rem] p-6";
            htmlString = `
                <div class="flex flex-col items-center justify-center min-h-[24rem] p-6">
                    <img src="{% static 'image/sedih-banget.png' %}" alt="Sad face" class="w-32 h-32 mb-4"/>
                    <p class="text-center text-gray-600 mt-4">Belum ada data product</p>
                </div>
            `;
        }
        else {
            classNameString = "flex flex-col space-y-6 items-center justify-center";
            productEntries.forEach((item) => {
                console.log(item);
                const author = item.fields.author;
                const id = item.pk;
                const judul = DOMPurify.sanitize(item.fields.judul);
                const gambar = item.fields.gambar;
                let konten = DOMPurify.sanitize(item.fields.konten);
                const jumlah_like = item.fields.jumlah_like;
                const tanggal = new Date(item.fields.tanggal).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
                const tanggal_pembaruan = new Date(item.fields.tanggal_pembaruan).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });

                // Batasi panjang teks konten, misalnya 100 karakter
                const maxKontenLength = 250;
                if (konten.length > maxKontenLength) {
                    konten = konten.substring(0, maxKontenLength) + '...';
                }

                htmlString += `
                <div class="card w-11/12 lg:w-2/3 mb-3 bg-[rgba(125,110,95,0.9)] text-[#fffbf2] rounded-lg shadow-lg transition-transform transform hover:scale-105">
                    <img src="/news/media/${gambar}" alt="${judul}" class="rounded-t-lg w-full h-56 object-cover">
                    <div class="p-4">
                        <h5 class="text-2xl font-semibold mb-2">${judul}</h5>
                        <p class="text-base mb-2">${konten}</p>
                        <p class="text-sm mb-2 flex justify-between">
                            <small>Author: ${author ? author : 'Unknown'}</small>
                            <small>Ditulis pada: ${tanggal}</small>
                            <small>Diperbarui pada: ${tanggal_pembaruan}</small>
                        </p>
                        <p class="text-sm mb-4">
                            <small>Jumlah Like: ${jumlah_like}</small>
                        </p>
                        <div class="flex mx-10 justify-between items-center">
                            <button type="submit" class="bg-[#c1a386] hover:bg-[#a48b72] text-[#fffbf2] font-bold py-2 px-4 rounded-lg transition duration-300 shadow-md" onclick="showEditModal('${id}')">
                                Edit
                            </button>
                            <button type="button" class="bg-[#c1a386] hover:bg-[#a48b72] text-[#fffbf2] font-bold py-2 px-4 rounded-lg transition duration-300 shadow-md" onclick="showDeleteModal('${id}')">
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
                `;
            });
        }
        document.getElementById("berita_entry_list").className = classNameString;
        document.getElementById("berita_entry_list").innerHTML = htmlString;
    }
    refreshBeritaList();

    function previewImage(event, wrapImageID) {
        const wrapImage = document.getElementById(`${wrapImageID}`);
        const file = event.target.files[0];
        const reader = new FileReader();

        reader.onload = function(e) {
        wrapImage.classList.remove('hidden');
        wrapImage.innerHTML = `<img id="imagePreview" src=${e.target.result} alt="Image Preview" class="object-cover w-auto h-auto rounded-md" />`;
        };

        if (file) {
        reader.readAsDataURL(file); 
        } else {
        wrapImage.innerHTML = "";
        }
    }


//   function previewImage(event, elementId) {
//     const file = event.target.files[0];
//     if (file) {
//         const reader = new FileReader();
//         reader.onload = function(e) {
//             document.getElementById(elementId).classList.remove('hidden'); // pastikan image wrapper terlihat
//             document.getElementById('edit_image_preview').src = e.target.result;
//         };
//         reader.readAsDataURL(file);
//     }
// }


</script>

<script>
    function addBerita() {
        fetch("{% url 'news:add_berita_ajax' %}", {
        method: "POST",
        body: new FormData(document.querySelector('#addBeritaForm')),
        })
        .then(response => {
            if (response.ok) {
                hideAddModal(); 
                refreshBeritaList(); 
            } else {
                console.error('Error deleting berita:', response.statusText);
            }
        })
        .catch(error => console.error('Error:', error));

        document.getElementById("addBeritaForm").reset(); 
        // document.querySelector("[data-modal-toggle='addModal']").click();
        return false;
    }

    function showAddModal() {
        const modal = document.getElementById('addModal');
        const modalContent = document.getElementById('addModalContent');

        modal.classList.remove('hidden'); 
        setTimeout(() => {
            modalContent.classList.remove('opacity-0', 'scale-95');
            modalContent.classList.add('opacity-100', 'scale-100');
        }, 50); 
    }

    function hideAddModal() {
        const modal = document.getElementById('addModal');
        const modalContent = document.getElementById('addModalContent');

        modalContent.classList.remove('opacity-100', 'scale-100');
        modalContent.classList.add('opacity-0', 'scale-95');

        setTimeout(() => {
            modal.classList.add('hidden');
        }, 150);
        
        const wrapImage = document.getElementById("wrapImageAdd");
        wrapImage.classList.add('hidden');
        wrapImage.innerHTML = ``;
    }

    document.getElementById("cancelAddButton").addEventListener("click", hideAddModal);
    document.getElementById("closeAddModalBtn").addEventListener("click", hideAddModal);
    document.getElementById("submitBeritaEntry").onclick = addBerita;

</script>

<script>
    function showEditModal(beritaId) {
        const modal = document.getElementById('editModal');
        const modalContent = document.getElementById('editModalContent');

        modal.classList.remove('hidden');
        setTimeout(() => {
            modalContent.classList.remove('opacity-0', 'scale-95');
            modalContent.classList.add('opacity-100', 'scale-100');
        }, 50);

        // Ambil data berita dari server berdasarkan ID
        fetch(`/news/edit_berita/${beritaId}`)
            .then(response => response.json())
            .then(data => {
                // Isi form dengan data yang diterima dari server
                document.getElementById('edit_judul').value = data[0].fields.judul;
                document.getElementById('edit_konten').value = data[0].fields.konten;
                const editImagePreview = document.getElementById('edit_image_preview');
                const gambar = data[0].fields.gambar;
    
                // Pratinjau gambar lama jika ada
                if (gambar) {
                    editImagePreview.src = `/news/media/${gambar}`; 
                    editImagePreview.alt = "Current Image";
                    document.getElementById('wrapImageEdit').classList.remove('hidden'); // Tampilkan pratinjau gambar
                } else {
                    editImagePreview.src = ""; // Kosongkan jika tidak ada gambar
                    editImagePreview.alt = "No image available";
                    document.getElementById('wrapImageEdit').classList.add('hidden'); // Sembunyikan pratinjau jika tidak ada gambar
                }

                // Simpan nama gambar lama di hidden field (opsional)
                document.getElementById('editBeritaForm').dataset.oldImage = data[0].fields.gambar;
            })
            .catch(error => console.error('Error:', error));

        document.getElementById("cancelEditButton").addEventListener("click", hideEditModal);
        document.getElementById("closeEditModalBtn").addEventListener("click", hideEditModal);

        document.getElementById('submitEditBeritaEntry').addEventListener('click', function(event) {
            event.preventDefault();

            const formData = new FormData(document.getElementById('editBeritaForm'));
            const csrftoken = document.querySelector('meta[name="csrf-token"]').content;

            // Mengirim request AJAX POST untuk update berita
            fetch(`/news/edit_berita/${beritaId}/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrftoken,  // Django requires a CSRF token for POST requests
                },
            })
            .then(response => {
                console.log(response);
                if (response.ok) {
                    hideEditModal(); // Tutup modal setelah berhasil delete
                    refreshBeritaList(); // Perbarui daftar berita
                } else {
                }
            }).catch(error => console.error('Error:', error));
        });
    }


    function hideEditModal() {
        const modal = document.getElementById('editModal');
        const modalContent = document.getElementById('editModalContent');

        modalContent.classList.remove('opacity-100', 'scale-100');
        modalContent.classList.add('opacity-0', 'scale-95');

        setTimeout(() => {
            modal.classList.add('hidden');
        }, 150); 
    }
        
</script>

<script>
    function showDeleteModal(beritaId) {
        const modal = document.getElementById('deleteModal');
        const modalContent = document.getElementById('deleteModalContent');

        modal.classList.remove('hidden'); 
        setTimeout(() => {
            modalContent.classList.remove('opacity-0', 'scale-95');
            modalContent.classList.add('opacity-100', 'scale-100');
        }, 50); 

        document.getElementById("cancelDeleteButton").addEventListener("click", hideDeleteModal);
        document.getElementById("closeDeleteModalBtn").addEventListener("click", hideDeleteModal);

        document.getElementById('confirmDeleteButton').onclick = function() {
            if (beritaId !== null) {
                // Gunakan beritaId di URL dengan cara yang benar
                const deleteUrl = `/news/delete_berita/${beritaId}/`;  // URL di sini disesuaikan dengan endpoint delete berita

                fetch(deleteUrl)
                .then(response => {
                    if (response.ok) {
                        hideDeleteModal(); // Tutup modal setelah berhasil delete
                        refreshBeritaList(); // Perbarui daftar berita
                    } else {
                        console.error('Error deleting berita:', response.statusText);
                    }
                })
                .catch(error => console.error('Error:', error));
            }
        };
    }

    function hideDeleteModal() {
        const modal = document.getElementById('deleteModal');
        const modalContent = document.getElementById('deleteModalContent');

        modalContent.classList.remove('opacity-100', 'scale-100');
        modalContent.classList.add('opacity-0', 'scale-95');

        setTimeout(() => {
            modal.classList.add('hidden');
        }, 150); 
    }
</script>
{% endblock content %}
