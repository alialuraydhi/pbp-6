{% extends 'base.html' %}
{% load static %}
{% block meta %}
<title>Berita</title>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
<script src="https://unpkg.com/boxicons@2.1.4/dist/boxicons.js"></script>
<meta name="csrf-token" content="{{ csrf_token }}">
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}
<div class="bg-[#f3ebdb]">
    <div class="container mx-auto px-4 py-8 mt-20 ">
        <h1 class="text-4xl font-bold text-center mb-8 text-[#c1a386]">
            Daftar Berita
        </h1>

        <div id="berita_entry_list" >
        </div>
    </div>
</div>


   <!--MODAL SPESIFIK BERITA  -->
    <div id="specificModel" tabindex="-1" aria-hidden="true" class="hidden fixed inset-0 z-50 w-full flex items-center justify-center bg-gray-800 bg-opacity-50 overflow-x-hidden overflow-y-auto transition-opacity duration-300 ease-out">
    <div id="specificModalContent" style="background-color: rgba(125, 110, 95, 0.9);" class="relative rounded-lg shadow-lg w-11/12 xl:w-2/3 mx-auto transform scale-95 opacity-0 transition-transform transition-opacity duration-300 ease-out">
        <!-- Modal header -->
        <div class="relative flex items-center justify-between p-6 border-b border-gray-300 rounded-t">
            <h3 id="modalJudulBerita" class="text-2xl font-semibold text-[#fffbf2]">
                Judul Berita
            </h3>
            <button type="button" class="absolute right-4 top-4 text-[#fffbf2] bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center" id="closeModalBtn">
                <svg aria-hidden="true" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
                <span class="sr-only">Close modal</span>
            </button>
        </div>

        <!-- Modal body with scrolling -->
        <div class="px-8 py-6 rounded-b-lg max-h-[70vh] overflow-y-auto">
            <!-- Gambar/Foto Berita -->
            <div class="relative w-full h-80 group mb-8">
                <img id="modalGambarBerita" src="{% static 'image/logo.png' %}" alt="Gambar Berita" class="w-full h-full object-cover rounded-lg transition-transform duration-500 group-hover:scale-110" loading="lazy">
                <!-- <div class="absolute bottom-3 left-3 bg-[#b9b1a9] bg-opacity-75 text-yellow-500 px-3 py-2 rounded-lg">
                    <h1 id="modalTanggalBeritaDate" class="text-5xl font-bold">26</h1>
                    <p id="modalTanggalBeritaMonth" class="text-base">Feb, 2024</p>
                </div> -->
            </div>

            <p id="modalTanggalBerita" class="text-[#fffbf2] text-lg right-0"></p>

            <p class="text-2xl font-bold text-[#fffbf2] ">Konten</p>
            <p id="modalKontenBerita" class="text-xl text-[#fffbf2] mb-3">${konten}</p>
            <div class="">
                <div class="text-sm mb-1 flex items-center justify-between">
                    <p class="flex items-center text-[#fffbf2]" id="modalAuthorBerita"></p>
                    <small class="text-[#fffbf2] text-lg" id="modalTanggapanUpdate"></small>
                </div>
                <p class="text-sm mb-1 flex text-[#fffbf2] items-center justify-center">
                    <button 
                        id="like-button"
                        class="like-button">
                        <svg id="like-icon" class="w-11 h-11 text-[#b9b1a9] hover:text-[#fffbf2] transition-colors duration-300  p-2" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" style="fill: rgba(0, 0, 0, 1);transform: ;msFilter:;"><path fill="currentColor" d="M4 21h1V8H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2zM20 8h-7l1.122-3.368A2 2 0 0 0 12.225 2H12L7 7.438V21h11l3.912-8.596L22 12v-2a2 2 0 0 0-2-2z"></path></svg>
                    </button>
                    <small class="text-[#fffbf2] text-lg" id="modalJumlahLike">${like}</small>
                </p>
            </div>
    </div>
</div>


<script>  
    async function getBerita(){
        return fetch("{% url 'news:show_berita_json' %}").then((res) => res.json())
    }

    async function refreshBeritaList() {
        document.getElementById("berita_entry_list").innerHTML = "";
        document.getElementById("berita_entry_list").className = "";
        const productEntries = await getBerita();
        
        let htmlString = "";
        let classNameString = "";
        if (productEntries.length === 0) {
            classNameString = "flex flex-col items-center justify-center min-h-[24rem] p-6";
            htmlString = `
                <div class="flex flex-col items-center justify-center min-h-[24rem] p-6">
                    <img src="{% static 'image/sedih-banget.png' %}" alt="Sad face" class="w-32 h-32 mb-4"/>
                    <p class="text-center text-gray-600 mt-4">Belum ada data product</p>
                </div>
            `;
        }
        else {
            classNameString = "flex flex-col space-y-6 items-center justify-center";
            productEntries.forEach((item) => {
                console.log(item);
                
                const author = item.fields.author;
                const id = item.pk;
                const judul = DOMPurify.sanitize(item.fields.judul);
                const gambar = `/news${item.fields.gambar}`;
                let konten = DOMPurify.sanitize(item.fields.konten);
                const like = item.fields.like;
                const liked = item.fields.liked;
                const tanggal = new Date(item.fields.tanggal).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
                const tanggal_pembaruan = new Date(item.fields.tanggal_pembaruan).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
                
                const data = {
                    "id": id,
                    "judul": judul,
                    "gambar": gambar,
                    "konten": konten,
                    "author": author,
                    "like": like,
                    "liked": liked,
                    "tanggal": tanggal,
                    "tanggal_pembaruan": tanggal_pembaruan
                };
                
                // Batasi panjang teks konten
                const maxKontenLength = 250;
                if (konten.length > maxKontenLength) {
                    konten = konten.substring(0, maxKontenLength) + '...';
                }

                // Tambahkan card berita
                htmlString += `
                    <div class="card w-11/12 lg:w-2/3 mb-3 bg-[rgba(125,110,95,0.9)] text-[#fffbf2] rounded-lg shadow-lg transition-transform transform hover:scale-105 flex flex-col lg:flex-row">
                        <img src="${gambar}" alt="${judul}" class="rounded-t-lg lg:rounded-l-lg w-full lg:w-1/2 h-56 object-cover lg:h-auto">
                        <div class="p-4 flex flex-col justify-between">
                            <h5 class="text-2xl font-semibold mb-2">${judul}</h5>
                            <small>${tanggal}</small>
                            
                            <p class="text-base mb-2">${konten}</p>
                            <div class="">
                                <div class="text-sm mb-1 flex items-center justify-between">
                                    <p class="flex items-center">
                                        <svg class="h-8 w-8 text-[#fffbf2] p-2" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" style="fill: rgba(0, 0, 0, 1);transform: ;msFilter:;"><path fill="currentColor" d="M7.5 6.5C7.5 8.981 9.519 11 12 11s4.5-2.019 4.5-4.5S14.481 2 12 2 7.5 4.019 7.5 6.5zM20 21h1v-1c0-3.859-3.141-7-7-7h-4c-3.86 0-7 3.141-7 7v1h17z"></path></svg>
                                        ${author ? author : 'Unknown'}
                                    </p>
                                    <small>Last Update:  ${tanggal_pembaruan}</small>
                                </div>
                                <p class="text-sm mb-1 flex text-[#fffbf2] items-center justify-center">
                                    <button 
                                        id="like-button-${id}"
                                        class="like-button" 
                                        onclick='toggleLike("${id}", this)'>
                                        <svg id="like-icon-${id}" class="w-11 h-11 ${liked ? 'text-[#fffbf2] hover:text-[#b9b1a9]' : 'text-[#b9b1a9] hover:text-[#fffbf2]' } transition-colors duration-300 hover:text-[#fffbf2] p-2" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" style="fill: rgba(0, 0, 0, 1);transform: ;msFilter:;"><path fill="currentColor" d="M4 21h1V8H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2zM20 8h-7l1.122-3.368A2 2 0 0 0 12.225 2H12L7 7.438V21h11l3.912-8.596L22 12v-2a2 2 0 0 0-2-2z"></path></svg>
                                    </button>
                                    <small id="jumlah-like-${id}">${like}</small>
                                </p>
                            </div>
                            <div id="data-${id}" style="display: none;">
                                ${JSON.stringify(data)}
                            </div>
                            <button class="bg-[#c5beb7] hover:bg-[#b9b1a9] text-white font-bold py-2 px-4 rounded" onclick='showModal("${id}")'>Details</button>
                        </div>
                    </div>
                `;



            });

        }
        document.getElementById("berita_entry_list").className = classNameString;
        document.getElementById("berita_entry_list").innerHTML = htmlString;
    }
    refreshBeritaList();

</script>

<script>
    function showModal(id) {
        const dataElement = document.getElementById(`data-${id}`);
        const data = JSON.parse(dataElement.textContent);

        // Update modal dengan data
        document.getElementById('modalJudulBerita').textContent = data.judul;
        document.getElementById('modalKontenBerita').innerHTML = data.konten;
        document.getElementById('modalGambarBerita').src = data.gambar;
        document.getElementById('modalAuthorBerita').innerHTML = `<svg class="h-11 w-11 text-[#fffbf2] p-2" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" style="fill: rgba(0, 0, 0, 1);transform: ;msFilter:;"><path fill="currentColor" d="M7.5 6.5C7.5 8.981 9.519 11 12 11s4.5-2.019 4.5-4.5S14.481 2 12 2 7.5 4.019 7.5 6.5zM20 21h1v-1c0-3.859-3.141-7-7-7h-4c-3.86 0-7 3.141-7 7v1h17z"></path></svg>${data.author ? data.author : 'Unknown'}`;
        document.getElementById('modalJumlahLike').innerHTML = `<span class="font-semibold">${data.like}</span>`;
        document.getElementById('modalTanggalBerita').innerHTML = `<span class="font-semibold right-0">${data.tanggal}</span>`;
        document.getElementById('modalTanggapanUpdate').innerHTML = `Last Update: <span class="font-semibold">${data.tanggal_pembaruan}</span>`;
        document.getElementById('like-button').addEventListener("click", () => toggleLike(id));

        const likeIcon = document.getElementById('like-icon');
        if (data.liked) {
            likeIcon.classList.add('text-[#fffbf2]');
            likeIcon.classList.add('hover:text-[#b9b1a9]');
            likeIcon.classList.remove('text-[#b9b1a9]');
            likeIcon.classList.remove('hover:text-[#fffbf2]');
        } else {
            likeIcon.classList.add('text-[#b9b1a9]');
            likeIcon.classList.add('hover:text-[#fffbf2]');
            likeIcon.classList.remove('text-[#fffbf2]');
            likeIcon.classList.remove('hover:text-[#b9b1a9]');
        }
      
        const modal = document.getElementById('specificModel');
        const modalContent = document.getElementById('specificModalContent');

        modal.classList.remove('hidden'); 
        setTimeout(() => {
            modalContent.classList.remove('opacity-0', 'scale-95');
            modalContent.classList.add('opacity-100', 'scale-100');
        }, 50); 
    }


    function hideModal() {
        const modal = document.getElementById('specificModel');
        const modalContent = document.getElementById('specificModalContent');

        modalContent.classList.remove('opacity-100', 'scale-100');
        modalContent.classList.add('opacity-0', 'scale-95');

        setTimeout(() => {
            modal.classList.add('hidden');
        }, 150); 
    }

    document.getElementById("closeModalBtn").addEventListener("click", hideModal);
</script>

<script>
    function toggleLike(threadId) {
        const likeButton = document.getElementById('like-button');
        const likeIcon = document.getElementById('like-icon'); // Ambil elemen SVG
        const originalText = likeButton.textContent;

        // Set the loading state
        likeButton.disabled = true;

        fetch(`/news/like_berita/${threadId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            console.log(data);
            
            // Update jumlah like di interface
            document.getElementById('modalJumlahLike').textContent = `${data.likes}`;

            // Ganti warna button berdasarkan status like
            if (data.liked) {
                likeIcon.classList.add('text-[#fffbf2]');
                likeIcon.classList.add('hover:text-[#b9b1a9]');
                likeIcon.classList.remove('text-[#b9b1a9]');
                likeIcon.classList.remove('hover:text-[#fffbf2]');
            } else {
                likeIcon.classList.add('text-[#b9b1a9]');
                likeIcon.classList.add('hover:text-[#fffbf2]');
                likeIcon.classList.remove('text-[#fffbf2]');
                likeIcon.classList.remove('hover:text-[#b9b1a9]');
            }
        })
        .catch(error => {
            likeButton.textContent = originalText;  // Reset to original text in case of error
        })
        .finally(() => {
            // Remove loading state
            refreshBeritaList();
            likeButton.disabled = false;
        });
    }

</script>
{% endblock content %}
