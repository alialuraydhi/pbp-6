<div
  id="thread-{{ thread.id }}"
  class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
  <div id="content-container-{{ thread.id }}">
    <p class="text-gray-800 mb-4">{{ thread.content }}</p>
  </div>

  {% if thread.image %}
  <img
    src="{{ thread.image.url }}"
    alt="Thread Image"
    class="max-h-[96px] rounded-md object-cover opacity-70 blur-sm hover:filter-none hover:opacity-100 transition-all duration-300 ease-in-out" />
  {% endif %}

  <div class="flex justify-between mt-4">
    <div class="flex items-center gap-4">
      <button
        id="like-button-{{ thread.id }}"
        class="like-button"
        onclick="toggleLike({{ thread.id }})">
        {{ thread.like_count }} Likes
      </button>
      <p>{{ thread.comment_count }} Comments</p>
    </div>

    {% if thread.author.id == user_id %}
    <div class="flex justify-end mt-4 gap-4" id="edit-buttons-{{ thread.id }}">
      <button
        class="text-blue-500 hover:text-blue-600 transition"
        onclick="toggleEditMode({{ thread.id }})">
        Edit
      </button>
      <button
        class="text-red-500 hover:text-red-600 transition"
        onclick="deleteThread({{ thread.id }})">
        Delete
      </button>
    </div>
    {% endif %}
  </div>
</div>

<script>
  (function () {
    let isEditMode = false;
    let originalContent = ""; // Store original content at module level

    window.toggleEditMode = function (threadId) {
      const contentContainer = $(`#content-container-${threadId}`);
      const editButtons = $(`#edit-buttons-${threadId}`);

      if (!isEditMode) {
        // Save original content when entering edit mode
        originalContent = contentContainer.find("p").text();

        contentContainer.html(`
          <textarea id="edit-content-${threadId}" class="w-full p-2 border border-gray-300 rounded mb-4">${originalContent}</textarea>
        `);

        editButtons.html(`
          <button class="text-blue-500 hover:text-blue-600 transition" onclick="submitEdit(${threadId})">Save</button>
          <button class="text-gray-500 hover:text-gray-600 transition" onclick="cancelEdit(${threadId})">Cancel</button>
        `);

        $(`#edit-content-${threadId}`).focus();
      } else {
        cancelEdit(threadId);
      }

      isEditMode = !isEditMode;
    };

    window.submitEdit = function (threadId) {
      const updatedContent = $(`#edit-content-${threadId}`).val();

      $.ajax({
        url: `edit/${threadId}/`,
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
          "Content-Type": "application/json",
        },
        data: JSON.stringify({ content: updatedContent }),
        success: function (data) {
          if (data.success) {
            const contentContainer = $(`#content-container-${threadId}`);
            contentContainer.html(
              `<p class="text-gray-800 mb-4">${
                data.data.content || updatedContent
              }</p>`
            );

            const editButtons = $(`#edit-buttons-${threadId}`);
            editButtons.html(`
              <button class="text-blue-500 hover:text-blue-600 transition" onclick="toggleEditMode(${threadId})">Edit</button>
              <button class="text-red-500 hover:text-red-600 transition" onclick="deleteThread(${threadId})">Delete</button>
            `);

            isEditMode = false;
          }
        },
        error: function (xhr, status, error) {
          console.error("Error:", error);
        },
      });
    };

    window.cancelEdit = function (threadId) {
      const contentContainer = $(`#content-container-${threadId}`);
      const editButtons = $(`#edit-buttons-${threadId}`);

      // Restore the original content without saving
      contentContainer.html(
        `<p class="text-gray-800 mb-4">${originalContent}</p>`
      );

      // Reset buttons
      editButtons.html(`
        <button class="text-blue-500 hover:text-blue-600 transition" onclick="toggleEditMode(${threadId})">Edit</button>
        <button class="text-red-500 hover:text-red-600 transition" onclick="deleteThread(${threadId})">Delete</button>
      `);

      isEditMode = false;
    };

    window.deleteThread = function (threadId) {
      $.ajax({
        url: `delete/${threadId}/`,
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
        },
        success: function (data) {
          if (data.success) {
            $(`#thread-${threadId}`).remove();
          }
        },
        error: function (xhr, status, error) {
          console.error("Error:", error);
        },
      });
    };

    window.toggleLike = function (threadId) {
      const likeButton = document.getElementById(`like-button-${threadId}`);
      const originalText = likeButton.textContent;

      likeButton.textContent = "Liking...";
      likeButton.disabled = true;

      fetch(`like/${threadId}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
          "Content-Type": "application/json",
        },
      })
        .then((response) => response.json())
        .then((data) => {
          likeButton.textContent = `${data.likes ?? 0} Likes`;

          if (data.liked) {
            likeButton.classList.add("text-red-600");
            likeButton.classList.remove("text-blue-500");
          } else {
            likeButton.classList.add("text-blue-500");
            likeButton.classList.remove("text-red-600");
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          likeButton.textContent = originalText;
        })
        .finally(() => {
          likeButton.disabled = false;
        });
    };
  })();
</script>
